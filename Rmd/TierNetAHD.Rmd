---
title: "Tiernet"
author: "Gauthier A."
date: "18/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(
  rio,        # importing data  
  here,       # relative file pathways
  readxl,     # read excel
  writexl,    # write excel
  #skimr,      # Exploring data
  janitor,    # data cleaning and tables
  lubridate,  # working with dates
  epikit,     # age_categories() function
  tidyverse,  # data management and visualization,
  #gtsummary,  # summary statistics and tests,
  #rstatix,    # summary statistics and statistical tests
  scales,     # easily convert proportions to percents  
  labelled,   # Variable and values labelling
  flextable,  # Format tables,
  sqldf,      #sql queries
  RODBC       # Odbc database connection
)


# use here from the here package
here <- here::here
# use clean_names from the janitor package
clean_names <- janitor::clean_names

# load functions used from R scripts
source_path <- here("R", "RScripts.R")
source(source_path,local = knitr::knit_global())
#Set vector size limit
memory.limit(size = 4000)

data_folder <- "data"
image_folder <- "images"
output_folder <- "output"


```

```{r, include=FALSE}

###############################################################################
#################   I. Importing & Exploring Data         #####################
###################   Version of Tier.net : 1.13.4      #######################
###############################################################################

con<-RODBC::odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb)};DBQ=C:/Users/Gauthier Abdala/Documents/RWD/TierNet/data/TierDESKinshasa042022.mdb")

vis_raw <- RODBC::sqlFetch(con,"VIS") #Follow Up clinic Visit table
pat_raw <- RODBC::sqlFetch(con,"PAT") #Socio demographic char. & outcome table
lab_raw <- RODBC::sqlFetch(con,"LAB") #Laboratory data table
dem_raw <- RODBC::sqlFetch(con,"DEM") #Demographic information

#pregnancy_raw <- RODBC::sqlFetch(con,"PREGNANCY")  #Pregnancy information
tb_raw        <- RODBC::sqlFetch(con,"TB")         #Tuberculosis Information
vis_tb_raw    <- RODBC::sqlFetch(con,"VIS_TB")     #TB Visit Table
transfers_raw <- RODBC::sqlFetch(con,"TRANSFERS")  #Transfer In/Out Table
#vis_preg_raw  <- RODBC::sqlFetch(con,"VIS_PREG")   #Antenatal Care
#infant_raw    <- RODBC::sqlFetch(con,"INFANT")     #Labour and Delivery


#############################################################################
########################      II. Cleaning data    ##########################
#############################################################################


############# 1. Cleaning column names    #################
###########################################################

vis <- vis_raw %>% janitor::clean_names()
pat <- pat_raw %>% janitor::clean_names()
lab <- lab_raw %>% janitor::clean_names()
dem <- dem_raw %>% janitor::clean_names()

#pregnancy <- pregnancy_raw  %>% janitor::clean_names()
tb        <- tb_raw         %>% janitor::clean_names()
vis_tb    <- vis_tb_raw     %>% janitor::clean_names()
transfers <- transfers_raw  %>% janitor::clean_names()
#vis_preg  <- vis_preg_raw   %>% janitor::clean_names()
#infant    <- infant_raw     %>% janitor::clean_names()


####### 2. Select,add and/or re order/rename columns #######
############################################################
vis <- vis %>%
  select(patient, visit_dmy, tb_status, who_stage, next_visit_dmy)

pat <- pat %>%
  select(patient, cohort, facility, birth_dmy,gender, frsvis_dmy,hivp_dmy, haart,
         haart_dmy, fhv_stage_who, tb_fhv, method_into_art, transfer_in_dmy, outcome,
         outcome_dmy)

lab <- lab %>%
  select(patient, lab_dmy, lab_id, lab_v, lab_t, episode_type, episode_id)

dem <- dem %>%
  select(patient, folder_number)

tb <- tb %>%
  select(patient, reg_dmy, tb_start_dmy, tb_end_dmy, tb_outcome, episode_id)

vis_tb <- vis_tb %>%
  select(patient, visit_dmy, next_visit_dmy, episode_id)

transfers <- transfers %>%
  select(patient, episode_id, facility_from, facility_to, transfer_dmy, transfer_action)



################ 3. Cleaning empty/null values     ##########
#############################################################

vis <-trim_data_columns(vis)
vis[is.null(vis)  | vis == "NULL" | vis == ""] <- NA

pat <-trim_data_columns(pat)
pat[is.null(pat)  | pat == "NULL" | pat == ""] <- NA

lab <-trim_data_columns(lab)
lab[is.null(lab)  | lab == "NULL" | lab == ""] <- NA

dem <-trim_data_columns(dem)
dem[is.null(dem)  | dem == "NULL" | dem == ""] <- NA

tb <-trim_data_columns(tb)
tb[is.null(tb)  | tb == "NULL" | tb == ""] <- NA

vis_tb <-trim_data_columns(vis_tb)
vis_tb[is.null(vis_tb)  | vis_tb == "NULL" | vis_tb == ""] <- NA

transfers <-trim_data_columns(transfers)
transfers[is.null(transfers)  | transfers == "NULL" | transfers == ""] <- NA


########### 4. Convert columns classes/add columns  #############
#################################################################
#is.date <- function(x) inherits(x, 'Date') #Used to check of column is date


vis <- vis %>%
  mutate(across(.cols = everything(), .fns = as.character)) %>% #Convert all columns to character class
  mutate(
    visit_dmy = parse_date(visit_dmy,"%Y-%m-%d"),
    next_visit_dmy = parse_date(next_visit_dmy,"%Y-%m-%d"),
    who_stage = parse_number(who_stage)
  ) %>%
  mutate(
    visit_dmy = as.Date(as.numeric(visit_dmy),origin ="1970-01-01"),
    next_visit_dmy = as.Date(as.numeric(next_visit_dmy),origin ="1970-01-01"),
    vis_year = year(visit_dmy)
  )


pat <- pat %>%
  mutate(across(.cols = everything(), .fns = as.character)) %>% #Convert all columns to character class
  mutate(
    birth_dmy = parse_date(birth_dmy,"%Y-%m-%d"),
    frsvis_dmy = parse_date(frsvis_dmy,"%Y-%m-%d"),
    hivp_dmy = parse_date(hivp_dmy,"%Y-%m-%d"),
    haart_dmy = parse_date(haart_dmy,"%Y-%m-%d"),
    transfer_in_dmy = parse_date(transfer_in_dmy,"%Y-%m-%d"),
    outcome_dmy = parse_date(outcome_dmy,"%Y-%m-%d"),
  ) %>%
  mutate(
    birth_dmy = as.Date(as.numeric(birth_dmy),origin ="1970-01-01"),
    frsvis_dmy = as.Date(as.numeric(frsvis_dmy),origin ="1970-01-01"),
    hivp_dmy = as.Date(as.numeric(hivp_dmy),origin ="1970-01-01"),
    haart_dmy = as.Date(as.numeric(haart_dmy),origin ="1970-01-01"),
    transfer_in_dmy = as.Date(as.numeric(transfer_in_dmy),origin ="1970-01-01"),
    outcome_dmy = as.Date(as.numeric(outcome_dmy),origin ="1970-01-01"),
    ) %>%
  mutate(
     #Add enrollment date
    enrol_date = case_when(
      method_into_art =="1" ~ transfer_in_dmy,
      method_into_art =="0" ~ haart_dmy 
    ),
    #Add enrollment year
    enrol_year  = year(enrol_date)
  )

lab <- lab %>%
  mutate(across(.cols = everything(), .fns = as.character)) %>% #Convert all columns to character class
  mutate(
    lab_dmy = parse_date(lab_dmy,"%Y-%m-%d"),
    lab_v = parse_number(lab_v)
  ) %>%
  mutate(
    lab_dmy = as.Date(as.numeric(lab_dmy),origin ="1970-01-01")
    )


tb <- tb %>%
  mutate(across(.cols = everything(), .fns = as.character)) %>% #Convert all columns to character class
  mutate(
    reg_dmy = parse_date(reg_dmy,"%Y-%m-%d"),
    tb_start_dmy = parse_date(tb_start_dmy,"%Y-%m-%d"),
    tb_end_dmy = parse_date(tb_end_dmy,"%Y-%m-%d"),
  ) %>%
  mutate(
    reg_dmy = as.Date(as.numeric(reg_dmy),origin ="1970-01-01"),
    tb_start_dmy = as.Date(as.numeric(tb_start_dmy),origin ="1970-01-01"),
    tb_end_dmy = as.Date(as.numeric(tb_end_dmy),origin ="1970-01-01"),
    )

vis_tb <- vis_tb %>%
  mutate(across(.cols = everything(), .fns = as.character)) %>% #Convert all columns to character class
  mutate(
    visit_dmy = parse_date(visit_dmy,"%Y-%m-%d"),
    next_visit_dmy = parse_date(next_visit_dmy,"%Y-%m-%d"),
  ) %>%
  mutate(
    visit_dmy = as.Date(as.numeric(visit_dmy),origin ="1970-01-01"),
    next_visit_dmy = as.Date(as.numeric(next_visit_dmy),origin ="1970-01-01")
    )

transfers <- transfers %>%
  mutate(across(.cols = everything(), .fns = as.character)) %>% #Convert all columns to character class
  mutate(
    transfer_dmy = parse_date(transfer_dmy,"%Y-%m-%d")
  ) %>%
  mutate(
    transfer_dmy = as.Date(as.numeric(transfer_dmy),origin ="1970-01-01")
    )

# transfers <- transfers %>%
#   filter(transfer_dmy >as.Date("2017-12-31") & facility_from == "CH KABINDA")


################ 5. Cleaning duplicate rows      #############
##############################################################
pat[duplicated(pat),]
pat<-unique(pat)

vis_duplicate <-vis[duplicated(vis),]
vis<-unique(vis)

lab_duplicate <-lab[duplicated(lab),]
lab<-unique(lab)
#TODO Cleaning of lab data for same exame encoded same date, different values...

tb_duplicate <-tb[duplicated(tb),]
tb<-unique(tb)

vis_tb_duplicate <-vis_tb[duplicated(vis_tb),]
vis_tb<-unique(vis_tb)

transfers_duplicate <-transfers[duplicated(transfers),]
transfers<-unique(transfers)

################# 5. Merge tables                #################
##################################################################

patient_full <-left_join(pat,dem,"patient")

vis_data <- left_join(vis,dem,"patient") %>%
  left_join(pat,"patient")



################# 6. Add variables/values labels    ##############
##################################################################
# labelled::val_labels(vis_data$gender)  <-c("1" = "Male", "2" = "Female", "95" = NA, "99" = NA)
# labelled::val_labels(vis_data$haart)   <-c("0" = "Not on ART", "1" = "on ART")
# labelled::val_labels(vis_data$outcome) <-c("10"= "Deceased", "20" = "In care", "30" = "Transfered Out", "40" = "LTFU", "95" = "Unknown")
# labelled::val_labels(vis_data$method_in_art_named) <-c("0" = "New", "1" = "Transfer In", "88" = NA )


## Remove unused/intermediate objects from memory

rm(list = c("dem_raw","lab_raw","pat_raw","tb_raw","transfers_raw","vis_raw","vis_tb_raw"))

```



```{r include=FALSE}

#############################################################################
##############      III. Analyzing data/presenting    #######################
#############################################################################


#Get visits for patients that date of visit = date of art start date


#Q/ Do we need a time window for initiations or do we keep strict art_start_date==visit_date


###################### CD4 LAB DATA ##############################
##################################################################
#A/ Given that in Tier.net we encode results dates for lab tests, we should have a time window check
#TODO : Need to remove duplicates for CD4 data encoded twice for the same visit


###CD4 Lab Data
lab_data_cd4 <-lab %>%
  filter((lab_id =="CD4A") & !is.na(lab_v)) %>%
  mutate(
    cd4_category = age_categories(
      lab_v,
      breakers = c(0,200,1000)
    )
  )


#vis_cd4 <- left_join(vis_data,lab_data_cd4,c("patient"="patient","visit_dmy"="lab_dmy"))

###!!! Important to clarify CD4 time window (here +-7 days) based on result turnaround time and validity period before requesting
###!!! If there exists two CD4 within the time window, which one to pick? Most recent one?

vis_cd4 <- sqldf(
  "select vis.visit_dmy,vis.patient,vis.next_visit_dmy,vis.folder_number,vis.cohort,vis.facility,vis.birth_dmy,
    vis.gender,vis.frsvis_dmy,vis.haart,vis.haart_dmy,vis.method_into_art,vis.tb_status,vis.transfer_in_dmy,vis.outcome,vis.outcome_dmy,vis.enrol_date,vis.enrol_year,lab.lab_dmy,lab.lab_v,lab.cd4_category 
    from vis_data vis
    left join lab_data_cd4 lab 
      on vis.patient = lab.patient and
        lab.lab_dmy  between (vis.visit_dmy-7)  and (vis.visit_dmy + 7) 
  "
)%>%
  rename(
    cd4_date = lab_dmy,
    cd4_value= lab_v
  )
 
#Filter duplicate lab results based on CD4 lab date
vis_cd4<-vis_cd4 %>%
  arrange(desc(cd4_date))

#Unique visits
#vis_cd4_data_dup<-vis_cd4[duplicated(vis_cd4[,1:16]),]
vis_cd4_data<-vis_cd4[!duplicated(vis_cd4[,1:16]),]

#Some duplicate visit data include
#Visits with different lab dates based on time window, need to decide which one to pick (soonest maybe?)
# 
# vis_cd4_data[!duplicated(vis_cd4_data[,1:16]),] %>%
#   arrange(patient)

###################### CRAG LAB DATA ##############################
##################################################################


lab_data_crag <-lab %>%
  filter((lab_id =="CRAG") & !is.na(lab_t)) 

vis_cd4_crag <- sqldf(
  "select cd4d.*,crag.lab_dmy,crag.lab_t
    from vis_cd4_data cd4d
    left join lab_data_crag crag
      on cd4d.patient = crag.patient
        and crag.lab_dmy between(cd4d.cd4_date -7) and(cd4d.cd4_date +7)
  "
)%>%
  rename(
    crag_date = lab_dmy,
    crag_value= lab_t
  )

vis_cd4_crag<-vis_cd4_crag %>%
  arrange(desc(crag_date))

#Unique visits
#vis_cd4_crag_data_dup<-vis_cd4_crag[duplicated(vis_cd4_crag[,1:19]),]
vis_cd4_crag_data<-vis_cd4_crag[!duplicated(vis_cd4_crag[,1:19]),]


###################### TBLAM LAB DATA ##############################
####################################################################

lab_data_tblam <-lab %>%
  filter((lab_id =="LAM") & !is.na(lab_t)) 

vis_cd4_crag_tbm <- sqldf(
  "select cd4crag.*,tb.lab_dmy,tb.lab_t
    from vis_cd4_crag_data cd4crag
    left join lab_data_tblam tb
      on cd4crag.patient = tb.patient
        and tb.lab_dmy between(cd4crag.cd4_date -7) and(cd4crag.cd4_date +7)
  "
)%>%
  rename(
    tbm_date = lab_dmy,
    tbm_value= lab_t
  )

vis_cd4_crag_tbm<-vis_cd4_crag_tbm %>%
  arrange(desc(tbm_date))

#Unique visits
#vis_cd4_crag_tbm_data_dup<-vis_cd4_crag_tbm[duplicated(vis_cd4_crag_tbm[,1:21]),]
vis_cd4_crag_tbm_data<-vis_cd4_crag_tbm[!duplicated(vis_cd4_crag_tbm[,1:21]),]


###################### LAST VL DATA #################################
#####################################################################

lab_data_vl <-lab %>%
  filter((lab_id =="RNA") & !is.na(lab_v))

#Get last VL up to 15 months(390 days) before current visit
#Assumption: Patient under care should have VL atleast once a year
vis_cd4_crag_tbm_lvl<-sqldf(
  "select data.*,vl.lab_dmy,vl.lab_v
    from vis_cd4_crag_tbm_data data
    left join lab_data_vl vl
      on data.patient = vl.patient
        and vl.lab_dmy between (data.visit_dmy -390) and (data.visit_dmy -1)"
)%>%
  rename(
    lastvl_date = lab_dmy,
    lastvl_value= lab_v
  )

vis_cd4_crag_tbm_lvl<-vis_cd4_crag_tbm_lvl %>%
  arrange(desc(lastvl_date))

#Unique visits
#vis_cd4_crag_tbm_lvl_data_dup<-vis_cd4_crag_tbm_lvl[duplicated(vis_cd4_crag_tbm_lvl[,1:23]),]
vis_cd4_crag_tbm_lvl_data<-vis_cd4_crag_tbm_lvl[!duplicated(vis_cd4_crag_tbm_lvl[,1:23]),]



  
## Remove unused/intermediate objects from memory

rm(list = c("vis_cd4","vis_cd4_data",
            "lab_data_crag","vis_cd4_crag","vis_cd4_crag_data",
            "lab_data_tblam","vis_cd4_crag_tbm","vis_cd4_crag_tbm_data",
            "lab_data_vl","vis_cd4_crag_tbm_lvl"))

###################### LAST CD4 DATA #################################
######################################################################

#Get last CD4 for patient
#Assumption: CD4 within 3 months of current visit may still be valid

vis_cd4_crag_tbm_lvl_l3cd4<-sqldf(
  "
    select data.*,cd4.lab_dmy,cd4.lab_v
    from vis_cd4_crag_tbm_lvl_data data
    left join lab_data_cd4 cd4
      on data.patient = cd4.patient
        and cd4.lab_dmy between (data.visit_dmy -90) and (data.visit_dmy-1)
  "
)%>%
  rename(
    last3cd4_date = lab_dmy,
    last3cd4_value= lab_v
  )

vis_cd4_crag_tbm_lvl_l3cd4<-vis_cd4_crag_tbm_lvl_l3cd4 %>%
  arrange(desc(last3cd4_date))

#Unique visits
#vis_cd4_crag_tbm_lvl_l3cd4_data_dup<-vis_cd4_crag_tbm_lvl_l3cd4[duplicated(vis_cd4_crag_tbm_lvl_l3cd4[,1:25]),]
vis_cd4_crag_tbm_lvl_l3cd4_data<-vis_cd4_crag_tbm_lvl_l3cd4[!duplicated(vis_cd4_crag_tbm_lvl_l3cd4[,1:25]),]


################## LAST NEXT APPOINTMENT DATA ########################
######################################################################

vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_data <- vis_cd4_crag_tbm_lvl_l3cd4_data %>%
  arrange(patient,visit_dmy)%>%
  group_by(patient) %>%
  mutate(# Get previous last next appointment and missed appointment days for patient
    last_next_app = lag(next_visit_dmy),
    miss_app_days = visit_dmy - last_next_app
  ) %>%
  select(last_next_app,visit_dmy,miss_app_days,everything())

#object.size(vis_cd4_crag_tbm_lvl_l3cd4_data)

########################## TRANSFER DATA #############################
######################################################################
#Add Transfers information to visit data
vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans <-vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_data%>%
  left_join(transfers,c("patient"="patient","visit_dmy"="transfer_dmy"))

vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans<-vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans %>%
  arrange(desc(visit_dmy))%>%
  #Move episode_id at the end
  relocate(episode_id,.after = last_col())

#Remove duplicate lines for transfers
#vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data_dup<-vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans[duplicated(vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans[,1:31]),]
#Note: This will include transfers in and transfers out that happened the same day as two separate lines
vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data<-vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans[!duplicated(vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans[,1:31]),]

#Adding a transfer category, transfer in or out
vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data<- vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data%>%
  mutate(
    trans_cat = case_when(
      mapply(identical,facility,facility_from)  ~ "transfer out",
      mapply(identical,facility,facility_to)  ~ "transfer in",
      TRUE ~ ""
    )
  )

## Remove unused/intermediate objects from memory

# rm(list = c("vis_cd4_crag_tbm_lvl_l3cd4","vis_cd4_crag_tbm_lvl_l3cd4_data",
#             "vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_data","vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans"))


```

##ELIGIBILITY CRITERIA
Note: It is important to note that some of the below eligibility criteria are not mutually exclusive, meaning a patient can belong to more than one eligibility criteria. As example, a patient can be returnee and has a high last VL. Important to clarify the order.  
-- Patients are considered and not visits events, meaning only first occurence of patient in the reporting period is considered
In the meantime, the following are assumptions for the eligibility:
New initiations : Patients who are starting ART 
  Exclusion : Transfers In
Returnees : Patients who are returning to care after being LTFUP (exact duration depends on settings/projects/countries)
High VL: Patients who visit the facility after having a high VL  
  Exclusion : Returnees

```{r INCLUDE=FALSE, fig.width=7.0}

######################################################################
####################### ELIBILITY CRITERIA ###########################
######################################################################


start_period <-as.Date("2021/01/01")
end_period   <-as.Date("2021/12/31")
pat_col_ind  <- 4 #Patient column index in the data frame
days_ltfup   <-90 #Days for ltfu. This can be context specific

#Summary data for AHD cascade
summ_data_ahd <-data.frame(matrix(nrow = 0,ncol=14))
col_names <- c("category","eligible","cd4_done","%cd4_done","cd4_lt200","%cd4_lt200",
               "lam_done","%lam_done","crag_done_","%crag_done","lam_pos","%lam_pos",
               "crag_pos","%crag_pos")
colnames(summ_data_ahd) <-col_names

vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data <- vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data %>%
  mutate(
    vis_quarter_year = quarter(visit_dmy, with_year = T),
    vis_month_year   = format(as.Date(visit_dmy), "%Y-%m"),
  )


# vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data<-vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data%>%
#   mutate(
#     #Add category for the eligibility criteria
#     elig_cat = case_when(
#        visit_dmy == haart_dmy & method_into_art == 0 ~ "Initiations",
#        
#     )
#   )


############################  PATIENTS WITH NO CD4   ###########################
################################################################################
#Q/ What time window between enrolment in cohort vs check for CD4?
#Joining patient table and lab table(CD4), then filter only patients with no CD4

# Assumption/ Eligibility : Patients enrolled  for >=12M at start of reporting period 
# and never had a CD4 by start of reporting period
# Def : Enrollment date == transfer in if method in art == 1/ art start date if 
# method in art == 0

#Get list of visits within reporting period for patients enrolled for >=12M 
#at the beginning of reporting period

#Get patients who have NEVER done a CD4 prior start of reporting
lab_data_cd4_temp <- lab_data_cd4 %>%
  filter(lab_dmy <start_period)

no_cd4_patient  <- patient_full %>%
  left_join(lab_data_cd4_temp,by = "patient") %>%
  #Get patients who do not have a CD4
  filter(is.na(lab_v))

no_cd4_pat_code <- unique(no_cd4_patient$patient)

#Remove object from memory
rm("lab_data_cd4_temp")

vis_gt_12m <- vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data %>%
 
  filter(
    #1. Filter only patients who have never done CD4 prior start of reporting period
      patient %in% no_cd4_pat_code
    #2. Filter visits for current reporting period
    &(visit_dmy>=start_period & visit_dmy<=end_period)
    
    #3. Filter patients enrolled for >=12M 
    & ((interval(enrol_date,start_period) %/% days(1) / (365/12)) >12 )
  ) %>%
  
  # Arrange to place first visit for patient with CD4 on top
  # Useful when filtering unique patients
  arrange(desc(patient),desc(cd4_date))

#Get unique patients

no_cd4_data_dup <- vis_gt_12m[duplicated(vis_gt_12m[,6:20]),]

#Patients with no CD4 ever eligibible for CD4 in current reporting period
no_cd4_data <- vis_gt_12m[!duplicated(vis_gt_12m[,6:20]),]

#Get unique patient codes with no CD4 to be used to avoid duplicate patients
no_cd4_pat_code <- unique(no_cd4_data$patient)

#Bind rows to summary data
summ_data_ahd <- summ_data_ahd %>%
  rbind(
    no_cd4_data %>%
       mutate(
        vis_year = year(visit_dmy)
      )%>%
      mutate(
        category    = "patient with no cd4",
      )%>%
      group_by(category) %>%
      summarise(
        eligible    = n(),
        cd4_done    = sum(!is.na(cd4_value),na.rm = TRUE),
        `%cd4_done` = round((cd4_done/eligible),4)*100, 
        cd4_lt200   = sum(cd4_value<200,na.rm = TRUE),
        `%cd4_lt200`= round((cd4_lt200/cd4_done),4)*100,
        lam_done    = sum(cd4_value<200 & !is.na(tbm_value),na.rm = TRUE),
        `%lam_done` = round((lam_done/cd4_lt200),4)*100,
        crag_done   = sum(cd4_value<200 & !is.na(crag_value),na.rm = TRUE),
        `%crag_done`= round((crag_done/cd4_lt200),4)*100,
        lam_pos     = sum(cd4_value<200 & !is.na(tbm_value) & (tbm_value=="+"),na.rm = TRUE),
        `%lam_pos`  = round((lam_pos/lam_done),4)*100,
        crag_pos    = sum(cd4_value<200 & !is.na(crag_value) & (crag_value=="+"),na.rm = TRUE),
        `%crag_pos` = round((crag_pos/crag_done),4)*100
        
      )
  )


###########################  NEW INITIATIONS   #################################
################################################################################



#Filter visits that happen on ART Start Date (new art initiations) and new patients (not transfers in)

new_init <-vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data %>%
  filter( 
    (visit_dmy>=start_period & visit_dmy<=end_period)
    #New initiations filtering
    & (visit_dmy == haart_dmy & method_into_art == 0)
    # Excludes patients already list of no CD4 patients to avoid double counting
    & !(patient %in% no_cd4_pat_code)
  )
new_init_data <- new_init[!duplicated(new_init[,6:20]),]

#Get unique patient codes with no CD4 to be used to avoid duplicate patients
new_init_pat_code <- unique(new_init_data$patient)

#Bind rows to summary data
summ_data_ahd <- summ_data_ahd %>%
  rbind(
    new_init_data %>%
       mutate(
        vis_year = year(visit_dmy)
      )%>%
      mutate(
        category    = "new art initiations",
      )%>%
      group_by(category) %>%
      summarise(
        eligible    = n(),
        cd4_done    = sum(!is.na(cd4_value),na.rm = TRUE),
        `%cd4_done` = round((cd4_done/eligible),4)*100, 
        cd4_lt200   = sum(cd4_value<200,na.rm = TRUE),
        `%cd4_lt200`= round((cd4_lt200/cd4_done),4)*100,
        lam_done    = sum(cd4_value<200 & !is.na(tbm_value),na.rm = TRUE),
        `%lam_done` = round((lam_done/cd4_lt200),4)*100,
        crag_done   = sum(cd4_value<200 & !is.na(crag_value),na.rm = TRUE),
        `%crag_done`= round((crag_done/cd4_lt200),4)*100,
        lam_pos     = sum(cd4_value<200 & !is.na(tbm_value) & (tbm_value=="+"),na.rm = TRUE),
        `%lam_pos`  = round((lam_pos/lam_done),4)*100,
        crag_pos    = sum(cd4_value<200 & !is.na(crag_value) & (crag_value=="+"),na.rm = TRUE),
        `%crag_pos` = round((crag_pos/crag_done),4)*100
        
      )
  )

# art_casc <-vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data %>%
#   filter(visit_dmy>=start_period & visit_dmy<=end_period)%>%
#    mutate(
#     quarter_year = quarter(visit_dmy, with_year = T),
#     month_year   = format(as.Date(visit_dmy), "%Y-%m"),
#   )%>%
#   
#   group_by(quarter_year,facility)%>%
#   summarise(
#     tot_vis       = n(),
#     tot_cd4       = sum(!is.na(cd4_value),na.rm = TRUE),
#     tot_in        = sum(visit_dmy == haart_dmy & method_into_art == 0,na.rm = TRUE),
#     cd4_in        = sum(visit_dmy == haart_dmy & method_into_art == 0 & !is.na(cd4_value),na.rm = TRUE),
#     `% cd4_in`    = round((cd4_in/tot_in),4)*100,
#     tot_cd4_lt200 = sum(cd4_value<200,na.rm = TRUE), #Tot CD4 < 200
#     cd4_lt200_in  = sum(visit_dmy == haart_dmy & method_into_art == 0 & !is.na(cd4_value) & cd4_value<200,na.rm = TRUE), #Tot CD4 < 200
#     cd4_lt200_oth = sum(!(visit_dmy == haart_dmy & method_into_art == 0) & !is.na(cd4_value) & cd4_value<200,na.rm = TRUE),
#     tot_lam       = sum(cd4_value<200 & !is.na(tbm_value),na.rm = TRUE),
#     `%tot_lam`    = round((tot_lam/tot_cd4_lt200),4)*100,
#     lam_in        = sum(visit_dmy == haart_dmy & method_into_art == 0 & !is.na(cd4_value) & cd4_value<200 & !is.na(tbm_value),na.rm = TRUE),
#     `%lam_in`     = round((lam_in/cd4_lt200_in),4)*100,
#     tot_crag      = sum(cd4_value<200 & !is.na(crag_value),na.rm = TRUE),
#     `%tot_crag`   = round((tot_crag/tot_cd4_lt200),4)*100,
#     crag_in       = sum(visit_dmy == haart_dmy & method_into_art == 0 & !is.na(cd4_value) & cd4_value<200 & !is.na(crag_value),na.rm = TRUE),
#     `%crag_in`    = round((crag_in/cd4_lt200_in),4)*100,
#     lam_pos       = sum(cd4_value<200 & !is.na(tbm_value) & (tbm_value=="+"),na.rm = TRUE),
#     `%lam_pos`    = round((lam_pos/tot_lam),4)*100,
#     crag_pos      = sum(cd4_value<200 & !is.na(crag_value) & (crag_value=="+"),na.rm = TRUE),
#     `%crag_pos`   = round((crag_pos/tot_crag),4)*100,
#   )# %>%
#   #adorn_totals()


###################################  RETURNEES   ###############################
################################################################################
#Outcome : 10, Death(HIV Related), 11: Death (HIV relationship unknown), 
#20: Alive and in care, 30,31: Transfers out
#40,41: LTFUP, 95: Not ascertained
#Def: These are people who have been LTFUP and are coming back to care


returnees<- vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data %>%
  filter(
    (visit_dmy>=start_period & visit_dmy<=end_period)
    # Filter patients who returned > days for ltfup
    & miss_app_days >days_ltfup 
    # Exclude patients already list of no CD4 patients to avoid double counting
    & !(patient %in% no_cd4_pat_code)
    )
  
#Filter to get unique patients in reporting period
#Get first occurrence of patient in reporting period

#Q/Consider most recent visit or first occurence? IMO, most recent as it reflects more recent 
# status of patient
returnees <-returnees%>%
  arrange(patient,desc(visit_dmy))

returnees_dup <-returnees[duplicated(returnees[,pat_col_ind]),]
returnees_data<-returnees[!duplicated(returnees[,pat_col_ind]),]

#Get unique patient codes with no CD4 to be used to avoid duplicate patients
returnees_pat_code <- unique(returnees_data$patient)

#Bind rows to summary data
summ_data_ahd <- summ_data_ahd %>%
  rbind(
    returnees_data %>%
       mutate(
        vis_year = year(visit_dmy)
      )%>%
      mutate(
        category    = "returnees",
      )%>%
      group_by(category) %>%
      summarise(
        eligible    = n(),
        cd4_done    = sum(!is.na(cd4_value),na.rm = TRUE),
        `%cd4_done` = round((cd4_done/eligible),4)*100, 
         cd4_lt200  = sum(cd4_value<200,na.rm = TRUE),
        `%cd4_lt200`= round((cd4_lt200/cd4_done),4)*100,
        lam_done    = sum(cd4_value<200 & !is.na(tbm_value),na.rm = TRUE),
        `%lam_done` = round((lam_done/cd4_lt200),4)*100,
        crag_done   = sum(cd4_value<200 & !is.na(crag_value),na.rm = TRUE),
        `%crag_done`= round((crag_done/cd4_lt200),4)*100,
        lam_pos     = sum(cd4_value<200 & !is.na(tbm_value) & (tbm_value=="+"),na.rm = TRUE),
        `%lam_pos`  = round((lam_pos/lam_done),4)*100,
        crag_pos    = sum(cd4_value<200 & !is.na(crag_value) & (crag_value=="+"),na.rm = TRUE),
        `%crag_pos` = round((crag_pos/crag_done),4)*100
        
      )
  )


#############################  HIGH VIRAL LOAD   ###############################
################################################################################

#Visits with last High VL

#Q/ Consider people with valid CD4 as still part of the cascade for tblam and crag

#Q/Consider most recent visit or first occurence? IMO, most recent as it reflects more recent 
# status of patient
high_vl <-vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data %>%
  filter(
    (
      visit_dmy>=start_period & visit_dmy<=end_period) 
      # Filter high VL
      & lastvl_value >1000
      # Exclude patients already list of no CD4 patients
      & !(patient %in% no_cd4_pat_code)
    ) %>%
  
  arrange(patient,desc(visit_dmy))

#Unique patients
high_vl_dup<-high_vl[duplicated(high_vl[,pat_col_ind]),]
high_vl_data<-high_vl[!duplicated(high_vl[,pat_col_ind]),]

#Get unique patient codes with no CD4 to be used to avoid duplicate patients
high_vl_pat_code <- unique(high_vl_data$patient)

#Bind rows to summary data
summ_data_ahd <- summ_data_ahd %>%
  rbind(
    high_vl_data %>%
       mutate(
        vis_year = year(visit_dmy)
      )%>%
      mutate(
        category    = "high vl",
      )%>%
      group_by(category) %>%
      summarise(
        eligible    = n(),
        cd4_done    = sum(!is.na(cd4_value),na.rm = TRUE),
        `%cd4_done` = round((cd4_done/eligible),4)*100, 
         cd4_lt200  = sum(cd4_value<200,na.rm = TRUE),
        `%cd4_lt200`= round((cd4_lt200/cd4_done),4)*100,
        lam_done    = sum(cd4_value<200 & !is.na(tbm_value),na.rm = TRUE),
        `%lam_done` = round((lam_done/cd4_lt200),4)*100,
        crag_done   = sum(cd4_value<200 & !is.na(crag_value),na.rm = TRUE),
        `%crag_done`= round((crag_done/cd4_lt200),4)*100,
        lam_pos     = sum(cd4_value<200 & !is.na(tbm_value) & (tbm_value=="+"),na.rm = TRUE),
        `%lam_pos`  = round((lam_pos/lam_done),4)*100,
        crag_pos    = sum(cd4_value<200 & !is.na(crag_value) & (crag_value=="+"),na.rm = TRUE),
        `%crag_pos` = round((crag_pos/crag_done),4)*100
        
      )
  )


#############################  OTHER CD4 DONE   ################################
################################################################################
# This includes all other patients who did CD4 not belonging in any of the eligible 
# categories
other_cd4 <- vis_cd4_crag_tbm_lvl_l3cd4_lstnxtapp_trans_data %>%
  filter(
    (
      visit_dmy>=start_period & visit_dmy<=end_period) 
    
      # Exclude patients already list of no CD4 patients
      & !(patient %in% no_cd4_pat_code)
      & !(patient %in% new_init_pat_code)
      & !(patient %in% returnees_pat_code)
      & !(patient %in% high_vl_pat_code)
    ) %>%
  
  arrange(patient,desc(visit_dmy))

#Unique patients
other_cd4_dup <-other_cd4[duplicated(other_cd4[,pat_col_ind]),]
other_cd4_data<-other_cd4[!duplicated(other_cd4[,pat_col_ind]),]

#Get unique patient codes with no CD4 to be used to avoid duplicate patients
other_cd4_pat_code <- unique(other_cd4_data$patient)

#Bind rows to summary data
summ_data_ahd <- summ_data_ahd %>%
  rbind(
    other_cd4_data %>%
       mutate(
        vis_year = year(visit_dmy)
      )%>%
      mutate(
        category    = "Other patients",
      )%>%
      group_by(category) %>%
      summarise(
        eligible    = NA,
        cd4_done    = sum(!is.na(cd4_value),na.rm = TRUE),
        `%cd4_done` = NA, 
        cd4_lt200   = sum(cd4_value<200,na.rm = TRUE),
        `%cd4_lt200`= round((cd4_lt200/cd4_done),4)*100,
        lam_done    = sum(cd4_value<200 & !is.na(tbm_value),na.rm = TRUE),
        `%lam_done` = round((lam_done/cd4_lt200),4)*100,
        crag_done   = sum(cd4_value<200 & !is.na(crag_value),na.rm = TRUE),
        `%crag_done`= round((crag_done/cd4_lt200),4)*100,
        lam_pos     = sum(cd4_value<200 & !is.na(tbm_value) & (tbm_value=="+"),na.rm = TRUE),
        `%lam_pos`  = round((lam_pos/lam_done),4)*100,
        crag_pos    = sum(cd4_value<200 & !is.na(crag_value) & (crag_value=="+"),na.rm = TRUE),
        `%crag_pos` = round((crag_pos/crag_done),4)*100
        
      )
  )


# high_vl_casc<-high_vl_data%>%
#   #Exclude initiations that might be part of the data (cross checking for data quality)
#   filter( 
#     !(visit_dmy == haart_dmy & method_into_art == 0)
#   )%>%
#   #Exclude patients who do not currently have a CD4 but have valid CD4 (<=3M)
#   filter(
#     !(is.na(cd4_value) & !is.na(last3cd4_value))
#   )%>%
#   mutate(
#     quarter_year = quarter(visit_dmy, with_year = T),
#     month_year   = format(as.Date(visit_dmy), "%Y-%m"),
#   )%>%
#   group_by(quarter_year)%>%
#   summarise(
#     tot_hvl        = n(),
#     cd4_hvl        = sum(!is.na(cd4_value)),
#     `% cd4_hvl`    = round((cd4_hvl/tot_hvl),4)*100,
#   )


###### TOTAL OF AHD CASCADE ######
str(summ_data_ahd)
summ_data_ahd <- summ_data_ahd %>%
  adorn_totals(where = "row")

#Update data in total now
total_row <- tail(summ_data_ahd,1) %>%
  mutate(
    category    = "Total(patient)",
    eligible    = NA,
    `%cd4_done` = NA, 
    `%cd4_lt200`= round((cd4_lt200/cd4_done),4)*100,
    `%lam_done` = round((lam_done/cd4_lt200),4)*100,
    `%crag_done`= round((crag_done/cd4_lt200),4)*100,
    `%lam_pos`  = round((lam_pos/lam_done),4)*100,
    `%crag_pos` = round((crag_pos/crag_done),4)*100
  )

summ_data_ahd[nrow(summ_data_ahd),] <-total_row

```


```{e INCLUDE=FALSE}

########################### RETURNEES   ##############################
######################################################################
#Outcome : 10, Death(HIV Related), 11: Death (HIV relationship unknown), 20: Alive and in care, 30,31: Transfers out
#40,41: LTFUP, 95: Not ascertained

#Function to return last next appointment date for a patient
#based on patient id and current visit
last_next_app_fnc <- function(patient_id, curr_vis_date){
  
  vis_dmy  <- as.Date(curr_vis_date)
  vis_dmy_2<- seq(vis_dmy, length=2, by="-2 years")[2] #Two years from current visit

  
  result <- vis_cd4_crag_tbm_data %>%#Visit for the last 5 years
    filter(
      (patient == patient_id) &
      (visit_dmy < curr_vis_date &  visit_dmy >=vis_dmy_2) #Filter visits before current visit date up to 2 years ago
    ) %>%
    arrange(desc(visit_dmy)) %>% #Sort by date of visit
    select(next_visit_dmy) %>% 
    head(1) #Only get the first top visit

  result <- ifelse(nrow(result)==0,NA,result)
  value <- result[[1]]
  return (value)
}


eligible_vis <- vis_cd4_crag_tbm_data %>%
  filter(
    visit_dmy >=as.Date("2021/01/01") & visit_dmy <=as.Date("2021/12/31")
  )%>%
  left_join(transfers,
            c("patient" = "patient", "visit_dmy" = "transfer_dmy")) %>%
  filter(#Excludes all transfers (in and out)
    is.na (facility_from)) %>% 
  mutate(#Get last next appointment date
    last_next_app_date =  (map2(patient, visit_dmy, last_next_app_fnc)))
    

# eligible_vis_data <- sqldf(
#   "select el.* from eligible_vis el
#     left join (select max(vis.visit_dmy) as last_app_date
#                   from vis_cd4_crag_tbm_data vis
#                     where vis.patient = el.patient and vis.visit_dmy <el.visit_dmy)  
#   "
# )
# 
# mysql <-sqldf(
#   "select max(vis.visit_dmy) as last_app_date
#                   from vis_cd4_crag_tbm_data vis
#                     where vis.patient = '11ec5d34-78ed-41c9-b156-49d2140fda47' and vis.visit_dmy < '04/03/2020'
#   "
# ) 

vis_dmy  <- as.Date("2022/01/01")
  vis_dmy_2<- seq(vis_dmy, length=2, by="-14 month")[2] 
  vis_dmy_2
  
  

```

